function h = bin2dplot(X, Y, varargin)

% Draw a 2d plot with 2d error bars with binned data (multilevel)
%
% Usage:
% -------------------------------------------------------------------------
% h = bin2dplot(Y, varargin)
%
% Inputs:
% -------------------------------------------------------------------------
% X     cell array: each cell for each subject contains any x-axis values
%       For example, it can be temperature (stimulus intensity)
% Y     cell array: each cell for each subject contains any y-axis values
%       that match with X. For example, it can be pain ratings. 
%
% Optional inputs: Enter keyword followed by variable with values
% 'ylim'     set up y-axis limit manually
% 'nbins'    the number of bins for x-axis (default: 4)
% 'colors'   colors of the dots; default: [0.8353 0.2431 0.3098];
% 'colors_refline'    colors for the reference line 
%                     default: [0.9569 0.4275 0.2627];
% 'refline'  draw reference line (regression); default: no refline
% 'reflinestyle'  linestyle for refline; default: '--'
% 'reflinewidth'                  linewidth for refline; default: 1
%
% Outputs:
% -------------------------------------------------------------------------
% h              graphic handles 
%   h{1}         entire figure 
%   h{2}         dots    
%   h{3}         reference line
%   h{4}         2d error bars
%
% Examples: 
% -------------------------------------------------------------------------
% % data
% for i = 1:10, X{i} = rand(20,1); Y{i} = rand(20,1); end
% h = bin2dplot(X, Y, 'nbins', 10, 'refline');
%
% col =  [0    0.1157    0.2686
%     0.1157    0.2765    0.4725
%     0.4843    0.1157    0.1078
%     0.3667    0.4765    0.1353
%     0.2765    0.1902    0.3824
%     0.0922    0.4216    0.5118
%     0.7941    0.3235   0];
%
% % draw
% h = bar_wani(y, e, .8, 'colors', col, 'errbar_width', [0 0], 'ast', p, 'ylim', [-2.5 2.5], 'ytick', -2:2, 'ast_adj_x', 0, 'ast_adj_y_neg', .15);
% set(gca, 'ytickLabel', num2str(get(gca, 'ytick')'));
% set(h, 'position', [1   531   399   169]);
% 
% savename = 'example_barwani.pdf';
% 
% try
%     pagesetup(h);
%     saveas(h, savename);
% catch
%     pagesetup(h);
%     saveas(h, savename);   
% end
%
% -------------------------------------------------------------------------
% Copyright (C) 2015  Wani Woo

% Programmers' notes:


doman_ylim = 0;
dorefline = 0;
nbins = 4;
reflinest = '--';
reflinew = 1;

colors = [0.8353    0.2431    0.3098];
colors_ref = [0.9569    0.4275    0.2627];


for i = 1:length(varargin)
    if ischar(varargin{i})
        switch varargin{i}
            % functional commands
            case {'ylim'}
                doman_ylim = 1;
                ylim = varargin{i+1};
            case {'colors', 'color'}
                colors = varargin{i+1};
            case {'colors_refline', 'colors_ref'}
                colors_ref = varargin{i+1};
            case {'refline'}
                dorefline = 1;
            case {'reflinestyle'}
                reflinest = varargin{i+1};
            case {'reflinewidth'}
                reflinew = varargin{i+1};
            case {'nbins'}
                nbins = varargin{i+1};

        end
    end
end

subjn = numel(X);

clear Xbins Ybins;

for i = 1:subjn
    
    % get binidx
    [~, sort_idx] = sort(X{i});
    binidx = zeros(numel(X{i}),1);
    if numel(unique(X{i})) == nbins
        u = unique(X{i});
        for j = 1:numel(u)
            binidx(X{i} == u(j)) = j;
        end
        
        for j = 1:nbins
            Xbins(i,j) = mean(X{i}(binidx==j));
            Ybins(i,j) = mean(Y{i}(binidx==j));
        end
        
    else
        algo = {'ceil', 'floor'};
        for j = 1:(nbins-1)
            algon = double(rand>.5)+1;
            eval(['tri_n = ' algo{algon} '(numel(X{i})./nbins);']);
            binidx(find(binidx==0, 1, 'first'):(find(binidx==0, 1, 'first')+tri_n-1)) = ...
                repmat(j, tri_n, 1);
        end
        binidx(binidx==0) = nbins;
        for j = 1:nbins
            Xbins(i,j) = mean(X{i}(sort_idx(binidx==j)));
            Ybins(i,j) = mean(Y{i}(sort_idx(binidx==j)));
        end
    end
    
end

x = mean(Xbins);
xe = ste(Xbins);

y = mean(Ybins);
ye = ste(Ybins);

h{1} = create_figure('2d_plot');
    
h{2} = scatter(x,y, 60, colors, 'filled');

if dorefline
    h{3} = refline;
    set(h{3}, 'Color', colors_ref, 'linewidth', reflinew, 'linestyle', reflinest);
end
% 
% if doindiv
%     for i = 1:subjn
%         scatter(Xbins(i,:), Ybins(i,:));
%     end
% end

xmin = min(x-xe) - range(x)*.05;
xmax = max(x+xe) + range(x)*.05;
% ymin = min(y-ye) - range(y)*.05;
% ymax = max(y+ye) + range(y)*.05;

xmin2 = min(x-xe) - range(x)*.1;
xmax2 = max(x+xe) + range(x)*.1;
ymin2 = min(y-ye) - range(y)*.1;
ymax2 = max(y+ye) + range(y)*.1;


for i = 1:numel(x)
    h{4}{i} = ploterr(x(i),y(i),xe(i),ye(i));
    set(h{4}{i}(1), 'marker', '.', 'color', colors, 'markersize', 1);
    set(h{4}{i}(2), 'color', colors, 'linewidth', 2);
    set(h{4}{i}(3), 'color', colors, 'linewidth', 2);
    xdata = get(h{4}{i}(2), 'xData');
    xdata(4:5) = xdata(1:2); xdata(7:8) = xdata(1:2);
    set(h{4}{i}(2), 'xdata', xdata);
    
    ydata = get(h{4}{i}(3), 'yData');
    ydata(4:5) = ydata(1:2); ydata(7:8) = ydata(1:2);
    set(h{4}{i}(3), 'ydata', ydata);
    hold on;
end

if dorefline
    xdata = get(h{3}, 'xdata');
    ydata = get(h{3}, 'ydata');
    slope = (ydata(2)-ydata(1))./(xdata(2) - xdata(1));
    intercept = ydata(2) - xdata(2).*slope;
    set(h{3}, 'xdata', [xmin xmax], 'ydata', [xmin*slope+intercept xmax*slope+intercept])
end

if doman_ylim
    set(gca, 'xlim', [xmin2 xmax2], 'ylim', ylim, 'linewidth', 1.2, 'fontsize', 18);
else
    set(gca, 'xlim', [xmin2 xmax2], 'ylim', [ymin2 ymax2], 'linewidth', 1.2, 'fontsize', 18);
end

end
